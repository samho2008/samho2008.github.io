(window.webpackJsonp=window.webpackJsonp||[]).push([[280],{2155:function(s,e,a){"use strict";a.r(e);var t=a(34),r=Object(t.a)({},(function(){var s=this,e=s.$createElement,a=s._self._c||e;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"redis-安全配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#redis-安全配置"}},[s._v("#")]),s._v(" Redis 安全配置")]),s._v(" "),a("p",[s._v("前段时间，经常在群里看到有同学在讨论服务器被挖矿木马入侵的问题。研究了一下，发现许多木马利用了 Redis 的安全漏洞实现入侵，以下整理了一些 Redis 安全加固的配置，予以防范。")]),s._v(" "),a("h2",{attrs:{id:"信任内网运行-尽量避免公网访问"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#信任内网运行-尽量避免公网访问"}},[s._v("#")]),s._v(" 信任内网运行，尽量避免公网访问")]),s._v(" "),a("hr"),s._v(" "),a("p",[s._v("Redis 自身只有一个密码控制访问，不能设置用户权限和 IP 限制。默认假设 Redis 运行在可以信任的网络环境中。")]),s._v(" "),a("p",[s._v("如果正常业务中 Redis 服务需要被其他服务器访问，可以通过 iptables 策略，仅允许指定的 IP 访问 Redis 服务。")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ iptables -A INPUT -s x.x.x.x -p tcp --dport "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v(" -j ACCEPT\n")])])]),a("h2",{attrs:{id:"绑定-redis-监听的网络接口"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#绑定-redis-监听的网络接口"}},[s._v("#")]),s._v(" 绑定 Redis 监听的网络接口")]),s._v(" "),a("hr"),s._v(" "),a("p",[s._v("如果服务器有多个 IP，可限定 Redis server 监听的 IP；通过 Redis 配置项 bind，可同时绑定多个 IP。")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("bind")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".13.12\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 在 redis.conf 配置文件中绑定本机 IP")]),s._v("\n")])])]),a("h2",{attrs:{id:"禁止-root-用户启动-redis"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#禁止-root-用户启动-redis"}},[s._v("#")]),s._v(" 禁止 root 用户启动 Redis")]),s._v(" "),a("hr"),s._v(" "),a("p",[s._v("使用普通用户启动，安全性往往高很多；业务程序永远别用 root 用户运行。")]),s._v(" "),a("p",[s._v("以较低权限账号运行 Redis 服务，并禁用该账号的登录权限。以下操作创建了一个无 home 目录权限，且无法登录的普通账号：")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("useradd")]),s._v(" -M -s /sbin/nologin "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("username"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])])]),a("h2",{attrs:{id:"限制-redis-文件目录访问权限"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#限制-redis-文件目录访问权限"}},[s._v("#")]),s._v(" 限制 Redis 文件目录访问权限")]),s._v(" "),a("hr"),s._v(" "),a("p",[s._v("设置 Redis 的主目录权限为 700；如果 Redis 配置文件独立于 Redis 主目录，权限修改为 600，因为 Redis 密码明文存储在配置文件中。")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("chmod")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("700")]),s._v(" /var/lib/redis\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("chmod")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("600")]),s._v(" /etc/redis/redis.conf\n")])])]),a("h2",{attrs:{id:"避免使用熟知端口"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#避免使用熟知端口"}},[s._v("#")]),s._v(" 避免使用熟知端口")]),s._v(" "),a("hr"),s._v(" "),a("p",[s._v("程序运行尽量避免使用熟知端口，降低被初级扫描的风险。")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("port "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6666")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 在 redis.conf 配置文件中修改监听端口")]),s._v("\n")])])]),a("h2",{attrs:{id:"开启-redis-密码认证-并设置高复杂度密码"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#开启-redis-密码认证-并设置高复杂度密码"}},[s._v("#")]),s._v(" 开启 Redis 密码认证，并设置高复杂度密码")]),s._v(" "),a("hr"),s._v(" "),a("p",[s._v("Redis 在 redis.conf 配置文件中，设置配置项"),a("code",[s._v("requirepass")]),s._v("，开启密码认证。")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" /etc/redis/redis.conf\nrequirepass ed4c39b015b0e46f074dbfd0a9a4ab278f63340a6d640999f25c68a932fef815\n")])])]),a("p",[s._v("Redis 因查询效率高，auth 这种命令每秒能处理 10w 次以上，简单的 Redis 密码极容易为攻击者暴破。")]),s._v(" "),a("p",[a("code",[s._v("requirepass")]),s._v("长度至少 20位 以上，为方便可使用特殊串命令"),a("code",[s._v("sha256sum")]),s._v("生成 64位 的无特殊字符串。")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"dfasdERQEWRQEW31341dfadsfadsf"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" sha256sum\naf970b3691a0774b2a5adae1375e14cd9e5db3591564f0eb789c2324cc02362f  -\n")])])]),a("h2",{attrs:{id:"禁用或重命名危险命令"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#禁用或重命名危险命令"}},[s._v("#")]),s._v(" 禁用或重命名危险命令")]),s._v(" "),a("hr"),s._v(" "),a("p",[s._v("Redis 无权限分离，其管理员账号和普通账号无明显区分。攻击者登录后可执行任意操作，因此需要隐藏以下重要命令："),a("code",[s._v("FLUSHDB")]),s._v(" "),a("code",[s._v("FLUSHALL")]),s._v(" "),a("code",[s._v("KEYS")]),s._v(" "),a("code",[s._v("PEXPIRE")]),s._v(" "),a("code",[s._v("DEL")]),s._v(" "),a("code",[s._v("CONFIG")]),s._v(" "),a("code",[s._v("SHUTDOWN")]),s._v(" "),a("code",[s._v("BGREWRITEAOF")]),s._v(" "),a("code",[s._v("BGSAVE")]),s._v(" "),a("code",[s._v("SAVE")]),s._v(" "),a("code",[s._v("SPOP")]),s._v(" "),a("code",[s._v("SREM")]),s._v(" "),a("code",[s._v("RENAME")]),s._v(" "),a("code",[s._v("DEBUG")]),s._v(" "),a("code",[s._v("EVAL")])]),s._v(" "),a("p",[s._v("另外，在 Redis 2.8.1 及 Redis 3.x （低于 3.0.2） 版本下存在 EVAL 沙箱逃逸漏洞，攻击者可通过该漏洞执行任意 Lua 代码。")]),s._v(" "),a("p",[s._v("下述配置将"),a("code",[s._v("config")]),s._v(" "),a("code",[s._v("flushdb")]),s._v(" "),a("code",[s._v("flushall")]),s._v("设置为空，即禁用该命令；也可设置为一些复杂的、难以猜测的名字。")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("rename-command CONFIG "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),s._v("\nrename-command flushall "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),s._v("\nrename-command flushdb "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),s._v("\nrename-command "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("shutdown")]),s._v(" shotdown_test\n")])])]),a("p",[s._v("保存后，执行"),a("code",[s._v("/etc/init.d/redis-server restart")]),s._v("重启生效。")]),s._v(" "),a("h2",{attrs:{id:"其它"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#其它"}},[s._v("#")]),s._v(" 其它")]),s._v(" "),a("hr"),s._v(" "),a("ol",[a("li",[a("p",[s._v("监控 Redis 安全状态，"),a("code",[s._v("cmdstat_auth")]),s._v(" "),a("code",[s._v("cmdstat_flushdb/flushall")]),s._v("监控报警。")])]),s._v(" "),a("li",[a("p",[s._v("Redis 设计旨在提供高性能的 K/V 服务，至少目前在权限访问控制和数据持久化方面比较弱化。所以禁止在 Redis 中存储或缓存敏感的明文数据。")])]),s._v(" "),a("li",[a("p",[s._v("针对之前 Redis 版本，默认无 bind 和密码设置存在很大安全风险；Redis 3.2 版本提供了新特性 protected mode（保护模式）。\n如果 Redis 在启动时，未开启 bind 密码设置功能，只能通过回环地址本地访问，如果尝试远程访问 Redis，会提示以下错误：")]),s._v(" "),a("blockquote",[a("p",[s._v("DENIED Redis is running protected mode because protected mode is enabled,\nno bind address was specified, no authentication password is requested to clients.\nIn this mode connections are only accepted from the loopback interface.")])]),s._v(" "),a("p",[s._v("当然也可以直接执行"),a("code",[s._v("CONFIG SET protected-mode no")]),s._v("，关闭保护模式。")])]),s._v(" "),a("li",[a("p",[s._v("Redis Cluster 不支持密码。")])])]),s._v(" "),a("blockquote",[a("p",[s._v("参考资料：")]),s._v(" "),a("p",[a("a",{attrs:{href:"https://www.jeffnotes.net/813",target:"_blank",rel:"noopener noreferrer"}},[s._v("Redis的安全配置"),a("OutboundLink")],1)]),s._v(" "),a("p",[a("a",{attrs:{href:"https://toutiao.io/posts/554283/app_preview",target:"_blank",rel:"noopener noreferrer"}},[s._v("记一个 Redis 安全漏洞和 Redis 安全规范"),a("OutboundLink")],1)]),s._v(" "),a("p",[a("a",{attrs:{href:"https://www.alibabacloud.com/help/zh/security-advisories/latest/unauthorized-access-vulnerability-in-redis",target:"_blank",rel:"noopener noreferrer"}},[s._v("Redis服务安全加固"),a("OutboundLink")],1)]),s._v(" "),a("p",[a("a",{attrs:{href:"https://www.cnblogs.com/zhoujie/p/redis2.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("redis访问安全加固"),a("OutboundLink")],1)])])])}),[],!1,null,null,null);e.default=r.exports}}]);